name: Integration Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  integration:
    name: Full Stack Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Create necessary directories
      run: |
        mkdir -p data/raw data/processed backend/models_saved

    - name: Start services with docker-compose
      run: |
        docker-compose up -d
        echo "Waiting for services to be ready..."
        sleep 45

    - name: Check backend health
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:8000/api/v1/health; then
            echo "Backend is healthy!"
            break
          fi
          echo "Waiting for backend... attempt $i"
          sleep 2
        done

    - name: Check frontend
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:5173; then
            echo "Frontend is up!"
            break
          fi
          echo "Waiting for frontend... attempt $i"
          sleep 2
        done

    - name: Test API endpoints
      run: |
        # Test health endpoint
        curl -f http://localhost:8000/api/v1/health

        # Test list datasets
        curl -f http://localhost:8000/api/v1/datasets/

        # Test matching endpoint
        curl -X POST http://localhost:8000/api/v1/match/predict \
          -H "Content-Type: application/json" \
          -d '{
            "record_a": {
              "fields": {"name": "John Smith", "city": "NYC"}
            },
            "record_b": {
              "fields": {"name": "J. Smith", "city": "New York"}
            }
          }'

    - name: View backend logs
      if: failure()
      run: docker-compose logs backend

    - name: View frontend logs
      if: failure()
      run: docker-compose logs frontend

    - name: Stop services
      if: always()
      run: docker-compose down -v
